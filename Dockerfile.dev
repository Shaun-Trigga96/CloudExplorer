# Dockerfile.dev
FROM node:24-slim

# Install essential tools
RUN apt-get update && apt-get install -y \
    git \
    curl \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Create a non-root user
RUN useradd -m appuser

# Set the working directory
WORKDIR /app

# Copy dependency files only
COPY package*.json ./

# Change ownership of these files to appuser
RUN chown -R appuser:appuser /app

# Switch to the non-root user for installing dependencies
USER appuser

# Install dependencies using npm
RUN npm install --no-bin-links --cache /tmp/.npm

# --- Stage 2: Copy Application Code ---

# Switch back to root to copy the rest of the files
USER root

# Copy the remaining application source code
COPY . .

# Ensure all files are owned by appuser
RUN chown -R appuser:appuser /app

# Switch back to the non-root user for running the app
USER appuser

# Make sure the app listens on the PORT environment variable
ENV PORT=5000

# Expose the necessary ports
EXPOSE ${PORT}

# Start the application
CMD ["npm", "run", "start"]
